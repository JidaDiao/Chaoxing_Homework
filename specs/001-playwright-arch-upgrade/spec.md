# Feature Specification: Playwright 架构升级

**Feature Branch**: `001-playwright-arch-upgrade`  
**Created**: 2026-01-21  
**Status**: Draft  
**Input**: User description: "根据doc/🏗️ Playwright 架构升级方案.md，升级项目架构"

## Clarifications

### Session 2026-01-21

- Q: 输出结果的覆盖策略 → A: 覆盖同名输出（保持现有行为）
- Q: 日志的敏感信息策略 → A: 日志脱敏（不记录学生姓名/作答内容）
- Q: 并发上限的默认策略 → C: 默认高并发（> 8）
- Q: 登录失败后的处理策略 → A: 立即失败并退出
- Q: 兼容迁移中旧 Selenium 文件的处理时机 → A: 迁移过程中立即删除旧文件

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 稳定完成作业爬取 (Priority: P1)

教师/管理员运行系统后，能够稳定完成作业数据爬取并保存结果，以便后续批改使用。

**Why this priority**: 这是系统的核心价值，爬取失败会直接导致业务不可用。

**Independent Test**: 提供有效账号和课程配置，执行爬取流程，验证指定作业的数据被保存且可读取。

**Acceptance Scenarios**:

1. **Given** 有效账号与课程配置，**When** 运行爬取流程，**Then** 目标作业数据被成功保存并可读
2. **Given** 课程存在多份作业，**When** 运行爬取流程，**Then** 系统可逐项完成并记录结果

---

### User Story 2 - 按课程/班级/作业筛选 (Priority: P2)

教师/管理员可以通过配置筛选需要处理的课程、班级或作业名称，系统仅处理匹配项。

**Why this priority**: 筛选能力决定了批量处理效率和可控性，直接影响实际使用体验。

**Independent Test**: 仅配置单个课程/班级/作业名，运行爬取流程，验证仅目标范围被处理。

**Acceptance Scenarios**:

1. **Given** 配置了课程与班级筛选，**When** 运行爬取流程，**Then** 仅匹配班级的数据被处理

---

### User Story 3 - 批改模块无缝兼容 (Priority: P3)

维护者完成迁移后，批改模块仍可直接使用爬取结果进行批改，无需额外改动。

**Why this priority**: 迁移的边界被严格限定，任何不兼容都会破坏现有批改流程。

**Independent Test**: 使用迁移后的爬取结果运行批改流程，验证输出正确且无兼容性错误。

**Acceptance Scenarios**:

1. **Given** 迁移后的爬取结果，**When** 运行批改流程，**Then** 批改流程正常完成且结果一致

---

### Edge Cases

- 当课程配置为空时，系统提示并安全结束
- 当登录失败或超时时，系统记录原因并停止爬取
- 当某课程无作业或无学生数据时，系统跳过并继续其他任务
- 当单个作业处理失败时，不影响其他作业继续执行

## Constitution Constraints *(mandatory)*

- **CC-001**: 变更范围仅限爬虫模块迁移
- **CC-002**: 受保护路径不得修改：`grader/`、`config/_args.py`、`config/config_manager.py`
- **CC-003**: 爬取输出的文件结构与数据格式必须保持兼容
- **CC-004**: 爬虫必须使用异步浏览器自动化并受控并发，禁止同步驱动
- **CC-005**: 新增代码必须包含类型标注、公共 API 文档与结构化日志

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持密码与二维码两种登录方式
- **FR-002**: 系统必须根据配置获取课程下的作业任务列表
- **FR-003**: 系统必须支持按课程、班级、作业名称进行筛选处理
- **FR-004**: 系统必须获取学生作答与参考答案并生成结构化结果
- **FR-005**: 系统必须将结果保存为批改模块可直接使用的文件结构
- **FR-006**: 系统必须保留现有的运行模式与使用方式，不改变用户操作习惯
- **FR-007**: 系统必须记录关键步骤与错误信息，便于定位失败原因
- **FR-008**: 单个任务失败不得中断其他任务的处理
- **FR-009**: 当输出路径已存在时，系统必须覆盖同名输出并更新结果
- **FR-010**: 日志不得包含学生姓名与作答内容等敏感信息
- **FR-011**: 默认并发上限必须大于 8，且支持配置覆盖
- **FR-012**: 登录失败时必须立即退出，并记录失败原因
- **FR-013**: 迁移过程中必须立即删除旧的 Selenium 相关文件

### Key Entities *(include if feature involves data)*

- **Course**: 课程，包含课程入口地址与所属班级集合
- **Class**: 班级，课程内的教学分组与作业归属
- **Homework Task**: 作业任务，包含作业名称、时间范围与处理链接
- **Student**: 学生，关联作业任务与答题记录
- **Answer Result**: 作业结果，包含题目结构、学生作答与参考答案

## Assumptions

- 提供的账号与课程链接有效且可访问
- 目标课程允许访问作业与批阅页面
- 运行环境具备稳定网络连接

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在代表性规模（不超过 10 门课、100 个作业）下，作业保存成功率 ≥ 95%
- **SC-002**: 对同一批作业结果，批改流程成功完成率达到 100%
- **SC-003**: 连续 10 次运行中，至少 9 次可在无人干预下完成
- **SC-004**: 90% 的作业任务在开始后 30 分钟内完成处理并产出结果
